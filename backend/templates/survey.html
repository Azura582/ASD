{% extends "base.html" %}

{% block title %}Survey - ASD Detection System{% endblock %}

{% block extra_css %}
<style>
    .question-card {
        transition: all 0.3s;
        min-height: 400px;
    }
    .answer-btn {
        width: 100%;
        padding: 20px;
        margin: 10px 0;
        border-radius: 10px;
        font-size: 20px;
        transition: all 0.3s;
    }
    .answer-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .progress-bar-custom {
        height: 8px;
        border-radius: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body p-4">
                <h2 class="text-center mb-4">
                    <i class="fas fa-clipboard-list text-primary me-2"></i>
                    ASD Survey
                </h2>
                
                <!-- 进度条 -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Progress</span>
                        <span id="progress-text">{% if step == 0 %}0{% else %}{{ ((step) / total_steps * 100)|int }}{% endif %}%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar bg-primary progress-bar-custom" 
                             role="progressbar" 
                             style="width: {% if step == 0 %}0{% else %}{{ (step / total_steps * 100)|int }}{% endif %}%"></div>
                    </div>
                </div>

                {% if step == 0 %}
                <!-- 基本信息表单 -->
                <div class="question-card">
                    <h4 class="mb-4">Basic Information</h4>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Age (months)</label>
                            <input type="number" class="form-control" id="age" placeholder="e.g.: 36" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Sex</label>
                            <select class="form-select" id="sex" required>
                                <option value="">Please select</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Ethnicity</label>
                            <select class="form-select" id="ethnicity" required>
                                <option value="">Please select</option>
                                <option value="Asian">Asian</option>
                                <option value="White">White</option>
                                <option value="Black">Black</option>
                                <option value="Others">Other</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Jaundice at birth?</label>
                            <select class="form-select" id="jaundice" required>
                                <option value="">Please select</option>
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Family history of ASD?</label>
                            <select class="form-select" id="asd_history" required>
                                <option value="">Please select</option>
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Respondent</label>
                            <select class="form-select" id="respondent" required>
                                <option value="">Please select</option>
                                <option value="Parent">Parent</option>
                                <option value="Health care professional">Health care professional</option>
                                <option value="Self">Self</option>
                                <option value="Others">Other</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary btn-lg w-100 mt-3" onclick="saveBasicAndNext()">
                        <i class="fas fa-arrow-right me-2"></i>Start Survey
                    </button>
                </div>

                {% elif step <= total_steps %}
                <!-- 问题页面 -->
                <div class="question-card">
                    <h4 class="mb-4 text-center">Question {{ step }} / {{ total_steps }}</h4>
                    <h5 class="mb-4 text-center">{{ question.text }}</h5>
                    
                    <div class="d-grid gap-3">
                        <button type="button" class="btn btn-outline-success answer-btn" 
                                onclick="saveAnswerAndNext('{{ question.id }}', 'Yes')">
                            <i class="fas fa-check-circle me-2"></i>Yes
                        </button>
                        <button type="button" class="btn btn-outline-danger answer-btn" 
                                onclick="saveAnswerAndNext('{{ question.id }}', 'No')">
                            <i class="fas fa-times-circle me-2"></i>No
                        </button>
                    </div>

                    {% if step > 1 %}
                    <button class="btn btn-secondary w-100 mt-4" onclick="location.href='/survey/{{ step - 1 }}'">
                        <i class="fas fa-arrow-left me-2"></i>Previous
                    </button>
                    {% endif %}
                </div>
                {% endif %}

                <!-- 加载动画 -->
                <div id="loading" style="display: none;" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Analyzing...</p>
                </div>

                <!-- 结果显示 -->
                <div id="result-section" style="display: none;">
                    <div class="alert" id="result-alert" role="alert">
                        <h4 class="alert-heading"><i class="fas fa-chart-line me-2"></i>Detection Result</h4>
                        <hr>
                        <div id="result-content"></div>
                    </div>
                    <button class="btn btn-primary w-100" onclick="location.href='/survey/0?reset=1'">
                        <i class="fas fa-redo me-2"></i>Retake Survey
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function saveBasicAndNext() {
    const age = $('#age').val();
    const sex = $('#sex').val();
    const ethnicity = $('#ethnicity').val();
    const jaundice = $('#jaundice').val();
    const asd_history = $('#asd_history').val();
    const respondent = $('#respondent').val();
    
    if (!age || !sex || !ethnicity || !jaundice || !asd_history || !respondent) {
        alert('Please complete all required basic information');
        return;
    }
    
    const basicInfo = { age, sex, ethnicity, jaundice, asd_history, respondent };
    
    $.ajax({
        url: '/survey/save_basic',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(basicInfo),
        success: function() {
            location.href = '/survey/1';
        },
        error: function(xhr, status, error) {
            alert('Save failed: ' + error);
        }
    });
}

function saveAnswerAndNext(questionId, answer) {
    $.ajax({
        url: '/survey/save_answer',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ question_id: questionId, answer: answer }),
        success: function() {
            {% if step == total_steps %}
            // 最后一题，提交所有答案
            submitAllAnswers();
            {% else %}
            // 跳转下一题
            location.href = '/survey/{{ step + 1 }}';
            {% endif %}
        },
        error: function(xhr, status, error) {
            alert('Save failed: ' + error);
        }
    });
}

function submitAllAnswers() {
    $('.question-card').hide();
    $('#loading').show();
    
    $.ajax({
        url: '/api/survey',
        type: 'POST',
        success: function(result) {
            $('#loading').hide();
            displayResult(result);
        },
        error: function(xhr, status, error) {
            $('#loading').hide();
            alert('Submission failed: ' + (xhr.responseJSON?.error || error));
            $('.question-card').show();
        }
    });
}

function displayResult(result) {
    if (result.error) {
        $('#result-alert').removeClass('alert-success alert-warning alert-danger')
                         .addClass('alert-danger');
        $('#result-content').html(`
            <p><strong>Error:</strong> ${result.error}</p>
            <p>${result.detail || ''}</p>
        `);
    } else {
        let alertClass = 'alert-success';
        // Support both Chinese and English risk labels
        if (result.risk_level === 'High Risk') alertClass = 'alert-danger';
        else if (result.risk_level === 'Medium Risk') alertClass = 'alert-warning';
        
        $('#result-alert').removeClass('alert-success alert-warning alert-danger')
                         .addClass(alertClass);
        
        const riskQuestions = result.risk_questions.map(q => 
            `<span class="badge bg-secondary">${q}</span>`
        ).join(' ');
        
        $('#result-content').html(`
            <div class="row">
                <div class="col-md-4 text-center mb-3">
                    <h2 class="display-4">${result.score}</h2>
                    <p class="text-muted">Risk Score</p>
                </div>
                <div class="col-md-4 text-center mb-3">
                    <h2 class="display-4">${result.risk_level}</h2>
                    <p class="text-muted">Risk Level</p>
                </div>
                <div class="col-md-4 text-center mb-3">
                    <h2 class="display-4">${result.prediction}</h2>
                    <p class="text-muted">Prediction</p>
                </div>
            </div>
            <hr>
            <p><strong>Risk Items:</strong> ${riskQuestions || 'None'}</p>
            <p class="text-muted mb-0">
                <i class="fas fa-info-circle me-2"></i>
                These results are for reference only. Consult a professional clinician for diagnosis.
            </p>
        `);
    }
    
    $('#result-section').show();
}
</script>
{% endblock %}
