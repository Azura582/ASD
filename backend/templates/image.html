{% extends "base.html" %}

{% block title %}图片检测 - ASD检测系统{% endblock %}

{% block extra_css %}
<style>
    .upload-area {
        border: 3px dashed #667eea;
        border-radius: 15px;
        padding: 60px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background: rgba(102, 126, 234, 0.05);
    }
    .upload-area:hover {
        background: rgba(102, 126, 234, 0.1);
        border-color: #764ba2;
    }
    .upload-area.dragging {
        background: rgba(102, 126, 234, 0.2);
        border-color: #764ba2;
    }
    #preview-image {
        max-width: 100%;
        max-height: 400px;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    }
    .result-box {
        display: none;
        animation: fadeIn 0.5s;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .behavior-badge {
        font-size: 1.2rem;
        padding: 10px 20px;
        border-radius: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body p-4">
                <h2 class="text-center mb-4">
                    <i class="fas fa-image text-info me-2"></i>
                    ASD图片检测
                </h2>
                
                <p class="text-center text-muted mb-4">
                    上传儿童行为照片，AI将识别以下典型自闭症行为模式：<br>
                    <span class="badge bg-primary me-2">头部撞击 (head_banging)</span>
                    <span class="badge bg-success me-2">原地旋转 (spinning)</span>
                    <span class="badge bg-warning me-2">手部拍动 (hand_flapping)</span>
                </p>

                <!-- 上传区域 -->
                <div id="upload-section">
                    <div class="upload-area" id="upload-area">
                        <i class="fas fa-cloud-upload-alt fa-4x text-primary mb-3"></i>
                        <h4>拖拽图片到此处 或 点击选择文件</h4>
                        <p class="text-muted">支持 JPG, PNG 格式，建议大小小于5MB</p>
                        <input type="file" id="file-input" accept="image/*" style="display: none;">
                    </div>
                    
                    <!-- 预览区域 -->
                    <div id="preview-section" class="mt-4 text-center" style="display: none;">
                        <img id="preview-image" src="" alt="预览图片">
                        <div class="mt-3">
                            <button class="btn btn-success btn-lg me-2" onclick="uploadImage()">
                                <i class="fas fa-check me-2"></i>开始检测
                            </button>
                            <button class="btn btn-secondary btn-lg" onclick="resetUpload()">
                                <i class="fas fa-redo me-2"></i>重新选择
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 加载动画 -->
                <div id="loading" style="display: none;" class="text-center">
                    <div class="spinner-border text-info" role="status" style="width: 4rem; height: 4rem;">
                        <span class="visually-hidden">分析中...</span>
                    </div>
                    <p class="mt-3 h5">AI正在分析图片...</p>
                    <p class="text-muted">这可能需要几秒钟</p>
                </div>

                <!-- 结果显示 -->
                <div id="result-section" class="result-box">
                    <div class="alert" id="result-alert" role="alert">
                        <h4 class="alert-heading"><i class="fas fa-chart-bar me-2"></i>检测结果</h4>
                        <hr>
                        <div id="result-content"></div>
                    </div>
                    <button class="btn btn-primary w-100" onclick="resetAll()">
                        <i class="fas fa-upload me-2"></i>检测新图片
                    </button>
                </div>
            </div>
        </div>

        <!-- 使用提示 -->
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-lightbulb text-warning me-2"></i>使用提示</h5>
                <ul class="mb-0">
                    <li>请上传清晰的儿童行为照片，确保主体明显</li>
                    <li>照片应包含完整的行为动作，避免模糊或遮挡</li>
                    <li>系统会给出识别的行为类型及置信度</li>
                    <li>本工具仅供辅助参考，不能替代专业诊断</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedFile = null;

// 上传区域点击事件
$('#upload-area').click(function() {
    $('#file-input').click();
});

// 文件选择事件
$('#file-input').change(function(e) {
    handleFile(e.target.files[0]);
});

// 拖拽事件
const uploadArea = document.getElementById('upload-area');

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragging');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragging');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragging');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
        handleFile(file);
    } else {
        alert('请上传有效的图片文件');
    }
});

function handleFile(file) {
    if (!file) return;
    
    // 验证文件大小 (5MB)
    if (file.size > 5 * 1024 * 1024) {
        alert('文件大小超过5MB，请选择更小的图片');
        return;
    }
    
    // 验证文件类型
    if (!file.type.startsWith('image/')) {
        alert('请上传图片文件');
        return;
    }
    
    selectedFile = file;
    
    // 显示预览
    const reader = new FileReader();
    reader.onload = function(e) {
        $('#preview-image').attr('src', e.target.result);
        $('#upload-area').hide();
        $('#preview-section').show();
    };
    reader.readAsDataURL(file);
}

function uploadImage() {
    if (!selectedFile) {
        alert('请先选择图片');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', selectedFile);
    
    $('#preview-section').hide();
    $('#loading').show();
    
    $.ajax({
        url: '/api/image',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(result) {
            $('#loading').hide();
            displayResult(result);
        },
        error: function(xhr, status, error) {
            $('#loading').hide();
            alert('检测失败: ' + (xhr.responseJSON?.error || error));
            $('#preview-section').show();
        }
    });
}

function displayResult(result) {
    if (result.error) {
        $('#result-alert').removeClass('alert-success alert-info')
                         .addClass('alert-danger');
        $('#result-content').html(`
            <p><strong>错误:</strong> ${result.error}</p>
            <p>${result.detail || ''}</p>
        `);
    } else {
        $('#result-alert').removeClass('alert-danger')
                         .addClass('alert-success');
        
        const behaviorMap = {
            'head_banging': { text: '头部撞击', icon: 'fa-head-side-virus', color: 'danger' },
            'spinning': { text: '原地旋转', icon: 'fa-sync-alt', color: 'primary' },
            'hand_flapping': { text: '手部拍动', icon: 'fa-hand-paper', color: 'warning' }
        };
        
        const behavior = behaviorMap[result.label] || { text: result.label, icon: 'fa-question', color: 'secondary' };
        
        let probsHtml = '';
        if (result.all_probabilities) {
            probsHtml = '<div class="mt-3"><h6>各类别置信度:</h6>';
            for (const [label, prob] of Object.entries(result.all_probabilities)) {
                const b = behaviorMap[label] || { text: label, color: 'secondary' };
                const percentage = (prob * 100).toFixed(2);
                probsHtml += `
                    <div class="mb-2">
                        <div class="d-flex justify-content-between mb-1">
                            <span>${b.text}</span>
                            <span class="text-muted">${percentage}%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-${b.color}" role="progressbar" 
                                 style="width: ${percentage}%" 
                                 aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                `;
            }
            probsHtml += '</div>';
        }
        
        $('#result-content').html(`
            <div class="text-center mb-4">
                <i class="fas ${behavior.icon} fa-5x text-${behavior.color} mb-3"></i>
                <h3>检测到行为: <span class="badge bg-${behavior.color} behavior-badge">${behavior.text}</span></h3>
                <p class="lead">置信度: <strong>${result.confidence}</strong></p>
            </div>
            ${probsHtml}
            <hr>
            <p class="text-muted text-center mb-0">
                <i class="fas fa-info-circle me-2"></i>
                检测结果仅供参考，如需确诊请咨询专业医生
            </p>
        `);
    }
    
    $('#result-section').show();
}

function resetUpload() {
    selectedFile = null;
    $('#file-input').val('');
    $('#preview-section').hide();
    $('#upload-area').show();
}

function resetAll() {
    resetUpload();
    $('#result-section').hide();
    $('#upload-section').show();
}
</script>
{% endblock %}
