{% extends "base.html" %}

{% block title %}photo detection - ASD detection system{% endblock %}

{% block extra_css %}
<style>
    .upload-area {
        border: 3px dashed #667eea;
        border-radius: 15px;
        padding: 60px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background: rgba(102, 126, 234, 0.05);
    }
    .upload-area:hover {
        background: rgba(102, 126, 234, 0.1);
        border-color: #764ba2;
    }
    .upload-area.dragging {
        background: rgba(102, 126, 234, 0.2);
        border-color: #764ba2;
    }
    #preview-image {
        max-width: 100%;
        max-height: 400px;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
    }
    .result-box {
        display: none;
        animation: fadeIn 0.5s;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .behavior-badge {
        font-size: 1.2rem;
        padding: 10px 20px;
        border-radius: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-body p-4">
                <h2 class="text-center mb-4">
                    <i class="fas fa-image text-info me-2"></i>
                    ASD detection
                </h2>
                
                <p class="text-center text-muted mb-4">
                    Upload photos of children's behavior. The AI can identify typical ASD-related behaviors:<br>
                    <span class="badge bg-primary me-2">head_banging</span>
                    <span class="badge bg-success me-2">spinning</span>
                    <span class="badge bg-warning me-2">hand_flapping</span>
                </p>

                <!--upload-->
                <div id="upload-section">
                    <div class="upload-area" id="upload-area">
                        <i class="fas fa-cloud-upload-alt fa-4x text-primary mb-3"></i>
                        <h4>Drag and drop the image here or click to select a file.</h4>
                        <p class="text-muted">Supports JPG and PNG formats; file size under 5MB is recommended.</p>
                        <input type="file" id="file-input" accept="image/*" style="display: none;">
                    </div>
                    
                    <!--preview-->
                    <div id="preview-section" class="mt-4 text-center" style="display: none;">
                        <img id="preview-image" src="" alt="Preview Image">
                        <div class="mt-3">
                            <button class="btn btn-success btn-lg me-2" onclick="uploadImage()">
                                <i class="fas fa-check me-2"></i>Start Detection
                            </button>
                            <button class="btn btn-secondary btn-lg" onclick="resetUpload()">
                                    <i class="fas fa-redo me-2"></i>Reselect 
                                </button>
                        </div>
                    </div>
                </div>

                <!--upload animation-->
                <div id="loading" style="display: none;" class="text-center">
                    <div class="spinner-border text-info" role="status" style="width: 4rem; height: 4rem;">
                        <span class="visually-hidden">analyzing...</span>
                    </div>
                    <p class="mt-3 h5">AI is analyzing the image...</p>
                    <p class="text-muted">This may take a few seconds</p>
                </div>

                <!--result-->
                <div id="result-section" class="result-box">
                    <div class="alert" id="result-alert" role="alert">
                        <h4 class="alert-heading"><i class="fas fa-chart-bar me-2"></i>Detection Result</h4>
                        <hr>
                        <div id="result-content"></div>
                    </div>
                    <button class="btn btn-primary w-100" onclick="resetAll()">
                        <i class="fas fa-upload me-2"></i>Detect New Photo
                    </button>
                </div>
            </div>
        </div>

        <!--tip-->
        <div class="card mt-4">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-lightbulb text-warning me-2"></i>Usage tips</h5>
                <ul class="mb-0">
                    <li>Please upload clear photos of the child's behavior, ensuring the subject is clearly visible.</li>
                    <li>Photos should capture the complete action, avoiding blurriness or obstruction.</li>
                    <li>The system will provide the identified behavior type and confidence level.</li>
                    <li>This tool is for supplementary reference only and cannot replace professional diagnosis.</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedFile = null;

// Upload area click event
$('#upload-area').click(function() {
    $('#file-input').click();
});

// File select event
$('#file-input').change(function(e) {
    handleFile(e.target.files[0]);
});

// Drag & drop events
const uploadArea = document.getElementById('upload-area');

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragging');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragging');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragging');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
        handleFile(file);
    } else {
        alert('Please upload a valid image file.');
    }
});

function handleFile(file) {
    if (!file) return;
    
    // Validate file size (5MB)
    if (file.size > 5 * 1024 * 1024) {
        alert('If the file size exceeds 5MB, please select a smaller image.');
        return;
    }
    
    // Validate file type
    if (!file.type.startsWith('image/')) {
        alert('Please upload an image file.');
        return;
    }
    
    selectedFile = file;
    
    // 显示预览
    const reader = new FileReader();
    reader.onload = function(e) {
        $('#preview-image').attr('src', e.target.result);
        $('#upload-area').hide();
        $('#preview-section').show();
    };
    reader.readAsDataURL(file);
}

function uploadImage() {
    if (!selectedFile) {
        alert('Please select an image first');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', selectedFile);
    
    $('#preview-section').hide();
    $('#loading').show();
    
    $.ajax({
        url: '/api/image',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(result) {
            $('#loading').hide();
            displayResult(result);
        },
        error: function(xhr, status, error) {
            $('#loading').hide();
            alert('Detection failed: ' + (xhr.responseJSON?.error || error));
            $('#preview-section').show();
        }
    });
}

function displayResult(result) {
    if (result.error) {
        $('#result-alert').removeClass('alert-success alert-info')
                         .addClass('alert-danger');
        $('#result-content').html(`
            <p><strong>wrong:</strong> ${result.error}</p>
            <p>${result.detail || ''}</p>
        `);
    } else {
        $('#result-alert').removeClass('alert-danger')
                         .addClass('alert-success');
        
        const behaviorMap = {
            'head_banging': { text: 'Head Banging', icon: 'fa-head-side-virus', color: 'danger' },
            'spinning': { text: 'Spinning', icon: 'fa-sync-alt', color: 'primary' },
            'hand_flapping': { text: 'Hand Flapping', icon: 'fa-hand-paper', color: 'warning' }
        };
        
        const behavior = behaviorMap[result.label] || { text: result.label, icon: 'fa-question', color: 'secondary' };
        
        let probsHtml = '';
        if (result.all_probabilities) {
            probsHtml = '<div class="mt-3"><h6>Class confidences:</h6>';
            for (const [label, prob] of Object.entries(result.all_probabilities)) {
                const b = behaviorMap[label] || { text: label, color: 'secondary' };
                const percentage = (prob * 100).toFixed(2);
                probsHtml += `
                    <div class="mb-2">
                        <div class="d-flex justify-content-between mb-1">
                            <span>${b.text}</span>
                            <span class="text-muted">${percentage}%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-${b.color}" role="progressbar" 
                                 style="width: ${percentage}%" 
                                 aria-valuenow="${percentage}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                `;
            }
            probsHtml += '</div>';
        }
        
                $('#result-content').html(`
            <div class="text-center mb-4">
                <i class="fas ${behavior.icon} fa-5x text-${behavior.color} mb-3"></i>
                <h3>Detected behavior: <span class="badge bg-${behavior.color} behavior-badge">${behavior.text}</span></h3>
                <p class="lead">Confidence: <strong>${result.confidence}</strong></p>
            </div>
            ${probsHtml}
            <hr>
            <p class="text-muted text-center mb-0">
                <i class="fas fa-info-circle me-2"></i>
                Detection results are for reference only. For diagnosis, consult a professional clinician.
            </p>
        `);
    }
    
    $('#result-section').show();
}

function resetUpload() {
    selectedFile = null;
    $('#file-input').val('');
    $('#preview-section').hide();
    $('#upload-area').show();
}

function resetAll() {
    resetUpload();
    $('#result-section').hide();
    $('#upload-section').show();
}
</script>
{% endblock %}
